import numpy as np
import tensorflow as tf

from src.estimator.model import siamese_conv_model
from testing_utils.tf_helpers import run_eagerly


@run_eagerly
def test_should_correctly_compare_distances_to_margin():
    distances = np.array([0, 0.1, 0.3, 0.4,
                          0.400001, 0.5, 1.5, 89])
    margin = 0.4
    result = siamese_conv_model.is_pair_similar(distances, margin)
    assert (result.numpy() == np.array([1.0, 1.0, 1.0, 1.0,
                                        0.0, 0.0, 0.0, 0.0])).all()


@run_eagerly
def test_should_correctly_compute_and_compare_distances():
    left_stack = np.array([[1.1694412, 0.38966152],
                           [0.85847193, -0.16187267],
                           [1.5156391, 0.49590212],
                           [0.708183, 0.94369954],
                           [0.38820785, 0.61577237],
                           [0.32889655, 0.6117578],
                           [1.2938937, 0.17881438],
                           [1.3877081, 0.57764626],
                           [1.4373021, 0.53360194],
                           [0.32702038, 0.13847739],
                           [1.3842099, -0.27757758],
                           [1.0432785, -0.14731856],
                           [0.512928, -0.24367276],
                           [1.4565573, 0.5056496],
                           [0.7015876, -0.27730402],
                           [0.96193796, -0.08985578],
                           [0.9361797, 0.5767883],
                           [1.4133427, 0.51929635],
                           [0.7705851, 0.5485229],
                           [1.417887, 0.5682071],
                           [0.70148915, 0.9469324],
                           [1.3497217, -0.24340542],
                           [1.2469236, 0.20561871],
                           [0.9057346, -0.20525713],
                           [0.8138226, 0.31222853]])
    right_stack = np.array([[1.1193063, 0.12167819],
                            [0.4247743, 0.07816438],
                            [1.3034458, 0.4858539],
                            [1.1654907, -0.26376498],
                            [0.39061838, 0.55987656],
                            [0.3605157, 0.57610375],
                            [1.2116414, 0.21025641],
                            [1.4635494, 0.5694422],
                            [1.4046503, -0.21258956],
                            [1.3259495, -0.20690194],
                            [1.2893131, -0.21597423],
                            [0.8491118, -0.17867406],
                            [0.36956948, 0.14978155],
                            [1.051756, 0.7356523],
                            [1.5060903, 0.49196652],
                            [0.4739363, 0.5232618],
                            [1.4971583, 0.52676004],
                            [1.2218608, 0.21629755],
                            [1.4683632, 0.5431378],
                            [0.82897824, -0.17975968],
                            [0.42128232, 0.61818856],
                            [1.3608543, -0.25830168],
                            [1.0839998, 0.6273559],
                            [0.7695698, 0.89610857],
                            [0.7350982, 0.34378213]])
    distances = siamese_conv_model.calculate_distance(left_stack, right_stack)

    assert np.allclose(distances.numpy(), np.array([[0.27263266],
                                                    [0.49569288],
                                                    [0.21243103],
                                                    [1.2911626],
                                                    [0.05594776],
                                                    [0.04765484],
                                                    [0.088057],
                                                    [0.07628375],
                                                    [0.74690557],
                                                    [1.0569514],
                                                    [0.11313874],
                                                    [0.19668213],
                                                    [0.41875765],
                                                    [0.46558058],
                                                    [1.1131046],
                                                    [0.78361905],
                                                    [0.56320494],
                                                    [0.35843214],
                                                    [0.6977988],
                                                    [0.95198095],
                                                    [0.43195876],
                                                    [0.01859659],
                                                    [0.45211327],
                                                    [1.109751],
                                                    [0.08481254]]))
    result = siamese_conv_model.is_pair_similar(tf.cast(distances, tf.float32), 0.25)
    assert (result.numpy() == np.array(
        [[0.], [0.], [1.], [0.], [1.], [1.], [1.], [1.], [0.], [0.], [1.], [1.], [0.], [0.], [0.], [0.], [0.], [0.],
         [0.], [0.], [0.], [1.], [0.], [0.],
         [1.]])).all()
    # [[1.], [0.], [1.], [0.], [1.], [1.], [1.], [1.], [0.], [0.], [1.], [1.], [0.], [0.], [0.], [0.], [0.], [1.],
    #  [0.], [0.], [0.], [1.], [0.], [0.],
    #  [1.]])).all()
